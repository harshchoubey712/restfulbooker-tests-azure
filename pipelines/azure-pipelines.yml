trigger:
  - main

pool:
  vmImage: "ubuntu-latest"

# üéõ UI Dropdown Parameters
parameters:
  - name: FEATURE
    displayName: "Select Feature Type"
    type: string
    default: "All"
    values:
      - All
      - CreateBooking
      - GetBooking
      - GetBookingIds
      - UpdateBooking

  - name: FLOW
    displayName: "Select Flow Type"
    type: string
    default: "All"
    values:
      - All
      - PositiveFlow
      - NegativeFlow

  - name: SCENARIO
    displayName: "Select Specific Scenario (optional)"
    type: string
    default: "All"
    values:
      - All
      - CreateBooking_Valid
      - GetBooking_ValidId
      - UpdateBooking_InvalidToken

# üß± Variables
variables:
  - group: RestfulBooker-TestVars

  # Docker setup
  - name: DOCKER_IMAGE
    value: "restfulbooker-tests"
  - name: TEST_PROJECT_PATH
    value: "tests/RestfulBooker.Acceptance"
  - name: TEST_PROJECT_FILE
    value: "RestfulBooker.Acceptance.csproj"
  - name: TEST_RESULTS_DIR
    value: "$(System.DefaultWorkingDirectory)/TestResults"
  - name: ALLURE_RESULTS_DIR
    value: "$(System.DefaultWorkingDirectory)/allure-results"
  - name: ALLURE_REPORT_DIR
    value: "$(System.DefaultWorkingDirectory)/allure-report"

stages:
  - stage: TestAndReport
    displayName: "üê≥ Run Tests + Generate Allure Report"
    jobs:
      - job: RunTests
        displayName: "Execute Tests in Docker"
        steps:
          # üß© Step 1 ‚Äî Install Docker
          - task: DockerInstaller@0
            displayName: "Install Docker CLI"

          # üß© Step 2 ‚Äî Build Docker image
          - script: |
              echo "üê≥ Building Docker image: $(DOCKER_IMAGE)"
              docker build -t $(DOCKER_IMAGE) $(TEST_PROJECT_PATH)
            displayName: "üê≥ Build Docker Image"

          # üß© Step 3 ‚Äî Run Tests with Smart Filter Logic
          - script: |
              echo "üîç Selected Feature: ${{ parameters.FEATURE }}"
              echo "üîç Selected Flow: ${{ parameters.FLOW }}"
              echo "üîç Selected Scenario: ${{ parameters.SCENARIO }}"

              FILTER=""

              # üéØ Feature filter
              case "${{ parameters.FEATURE }}" in
                "CreateBooking") FILTER="TestCategory=CreateBooking" ;;
                "GetBooking") FILTER="TestCategory=GetBooking" ;;
                "GetBookingIds") FILTER="TestCategory=GetBookingIds" ;;
                "UpdateBooking") FILTER="TestCategory=UpdateBooking" ;;
              esac

              # üéØ Scenario filter (takes priority)
              if [ "${{ parameters.SCENARIO }}" = "CreateBooking_Valid" ]; then
                FILTER="TestCategory=CreateBooking_Valid"
              elif [ "${{ parameters.SCENARIO }}" = "GetBooking_ValidId" ]; then
                FILTER="TestCategory=GetBooking_ValidId"
              elif [ "${{ parameters.SCENARIO }}" = "UpdateBooking_InvalidToken" ]; then
                FILTER="TestCategory=UpdateBooking_InvalidToken"
              fi

              # üéØ Flow filter combine
              if [ "${{ parameters.FLOW }}" = "PositiveFlow" ]; then
                if [ -z "$FILTER" ]; then
                  FILTER="TestCategory=PositiveFlow"
                else
                  FILTER="$FILTER&TestCategory=PositiveFlow"
                fi
              elif [ "${{ parameters.FLOW }}" = "NegativeFlow" ]; then
                if [ -z "$FILTER" ]; then
                  FILTER="TestCategory=NegativeFlow"
                else
                  FILTER="$FILTER&TestCategory=NegativeFlow"
                fi
              fi

              # üß© Prepare clean folders
              rm -rf $(TEST_RESULTS_DIR) $(ALLURE_RESULTS_DIR) $(ALLURE_REPORT_DIR)
              mkdir -p $(TEST_RESULTS_DIR) $(ALLURE_RESULTS_DIR) $(ALLURE_REPORT_DIR)

              # ‚úÖ Run tests inside Docker
              if [ -z "$FILTER" ] || [ "$FILTER" = "All" ]; then
                echo "üéØ Running all tests (no filter applied)"
                docker run --rm \
                  -v $(TEST_RESULTS_DIR):/app/TestResults \
                  -v $(ALLURE_RESULTS_DIR):/app/allure-results \
                  -v $(ALLURE_REPORT_DIR):/app/allure-report \
                  $(DOCKER_IMAGE) \
                  bash -c "dotnet test $(TEST_PROJECT_FILE) -c Release --no-build \
                  --results-directory /app/TestResults \
                  --logger:'trx;LogFileName=test_results.trx' && \
                  allure generate /app/allure-results --clean -o /app/allure-report"
              else
                echo "üéØ Running filtered tests ‚Üí $FILTER"
                docker run --rm \
                  -v $(TEST_RESULTS_DIR):/app/TestResults \
                  -v $(ALLURE_RESULTS_DIR):/app/allure-results \
                  -v $(ALLURE_REPORT_DIR):/app/allure-report \
                  $(DOCKER_IMAGE) \
                  bash -c "dotnet test $(TEST_PROJECT_FILE) -c Release --no-build \
                  --filter \"$FILTER\" \
                  --results-directory /app/TestResults \
                  --logger:'trx;LogFileName=test_results.trx' && \
                  allure generate /app/allure-results --clean -o /app/allure-report"
              fi
            displayName: "üöÄ Run Tests with Category-Based Smart Filter"

          # üß© Step 4 ‚Äî Publish TRX Results as Artifact
          - task: PublishBuildArtifacts@1
            displayName: "üì¶ Publish TRX Results"
            inputs:
              PathtoPublish: "$(TEST_RESULTS_DIR)"
              ArtifactName: "TestResults"
              publishLocation: "Container"

          # üß© Step 5 ‚Äî Publish Allure HTML Report as Artifact
          - task: PublishBuildArtifacts@1
            displayName: "üì¶ Publish Allure HTML Report"
            inputs:
              PathtoPublish: "$(ALLURE_REPORT_DIR)"
              ArtifactName: "AllureReport"
              publishLocation: "Container"

          # üß© Step 6 ‚Äî Show Allure Report in Azure DevOps Tab
          - task: PublishAllureReport@1
            displayName: "üìä Publish Allure Report in Build Summary"
            inputs:
              reportDir: "$(ALLURE_REPORT_DIR)"
              resultsDir: "$(ALLURE_RESULTS_DIR)"
              allureVersion: "2.29.0"
              reportName: "RestfulBooker Automated Tests"
              includeSubFolders: true
              cleanResults: false
